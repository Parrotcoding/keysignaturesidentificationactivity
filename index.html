<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Key Signature Identification Activity</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --sky: #d9ecff;
      --panel: #ffffff;
      --text: #10304f;
      --accent: #1d6acb;
      --border-radius: 28px;
      --pill-radius: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 3rem clamp(1rem, 4vw, 3rem);
      background: var(--sky);
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    main {
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: clamp(1.25rem, 3vw, 2rem);
    }

    .panel {
      background: var(--panel);
      border-radius: var(--border-radius);
      padding: clamp(1.5rem, 3vw, 2.5rem);
      box-shadow: 0 18px 40px rgba(16, 48, 79, 0.12);
      border: 1px solid rgba(16, 48, 79, 0.1);
      position: relative;
    }

    .key-area {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .staff-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 1rem;
    }

    svg {
      width: 100%;
      max-width: 420px;
      height: auto;
    }

    .signature-meta {
      font-size: 1rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: rgba(16, 48, 79, 0.65);
    }

    h1 {
      margin: 0;
      font-size: clamp(1.5rem, 4vw, 2.25rem);
      font-weight: 700;
    }

    .questions {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    label {
      font-weight: 600;
      font-size: 1.05rem;
    }

    input[type="text"] {
      padding: 0.85rem 1.2rem;
      border-radius: var(--pill-radius);
      border: 2px solid rgba(29, 106, 203, 0.25);
      font-size: 1rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(29, 106, 203, 0.2);
    }

    button {
      align-self: flex-start;
      padding: 0.85rem 1.6rem;
      border: none;
      border-radius: var(--pill-radius);
      background: var(--accent);
      color: white;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    button:hover {
      background: #1556a5;
    }

    button:active {
      transform: translateY(1px);
    }

    .feedback {
      border-radius: var(--border-radius);
      padding: 0.9rem 1.2rem;
      background: rgba(29, 106, 203, 0.08);
      border: 1px solid rgba(29, 106, 203, 0.18);
      font-weight: 600;
      color: #0c2c4b;
    }

    .hidden {
      display: none !important;
    }

    .next-button {
      margin-top: 0.5rem;
    }

    @media (max-width: 880px) {
      body {
        padding: 2rem 1rem 3rem;
      }

      main {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <section class="panel key-area" aria-live="polite">
      <div>
        <h1>Identify the Key Signature</h1>
        <p class="signature-meta" id="signature-meta"></p>
      </div>
      <div class="staff-container" id="staff-container" aria-label="Current key signature"></div>
    </section>
    <section class="panel questions" aria-live="polite">
      <form id="major-form">
        <label for="major-input">1. What is the major key signature?</label>
        <input id="major-input" type="text" autocomplete="off" placeholder="e.g. G major" required />
        <button type="submit">Submit Major Key</button>
        <div id="major-feedback" class="feedback hidden" role="status"></div>
      </form>
      <form id="minor-form" class="hidden">
        <label for="minor-input">2. What is the minor key signature?</label>
        <input id="minor-input" type="text" autocomplete="off" placeholder="e.g. E minor" required />
        <button type="submit">Submit Minor Key</button>
        <div id="minor-feedback" class="feedback hidden" role="status"></div>
      </form>
      <button id="next-button" class="next-button hidden" type="button">Next Key Signature</button>
    </section>
  </main>
  <script>
    const svgNS = "http://www.w3.org/2000/svg";

    const keySignatures = [
      { major: "C major", minor: "A minor", type: "natural", count: 0 },
      { major: "G major", minor: "E minor", type: "sharp", count: 1 },
      { major: "D major", minor: "B minor", type: "sharp", count: 2 },
      { major: "A major", minor: "F# minor", type: "sharp", count: 3 },
      { major: "E major", minor: "C# minor", type: "sharp", count: 4 },
      { major: "B major", minor: "G# minor", type: "sharp", count: 5 },
      { major: "F# major", minor: "D# minor", type: "sharp", count: 6 },
      { major: "C# major", minor: "A# minor", type: "sharp", count: 7 },
      { major: "F major", minor: "D minor", type: "flat", count: 1 },
      { major: "Bb major", minor: "G minor", type: "flat", count: 2 },
      { major: "Eb major", minor: "C minor", type: "flat", count: 3 },
      { major: "Ab major", minor: "F minor", type: "flat", count: 4 },
      { major: "Db major", minor: "Bb minor", type: "flat", count: 5 },
      { major: "Gb major", minor: "Eb minor", type: "flat", count: 6 },
      { major: "Cb major", minor: "Ab minor", type: "flat", count: 7 }
    ];

    const sharpSteps = [8, 5, 9, 6, 3, 7, 4];
    const flatSteps = [4, 1, 5, 2, 6, 3, 7];

    const majorForm = document.getElementById("major-form");
    const minorForm = document.getElementById("minor-form");
    const majorInput = document.getElementById("major-input");
    const minorInput = document.getElementById("minor-input");
    const majorFeedback = document.getElementById("major-feedback");
    const minorFeedback = document.getElementById("minor-feedback");
    const nextButton = document.getElementById("next-button");
    const signatureMeta = document.getElementById("signature-meta");
    const staffContainer = document.getElementById("staff-container");

    let usedIndices = [];
    let currentKey = null;

    function createStaff(key) {
      staffContainer.innerHTML = "";

      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", "0 0 420 200");
      svg.setAttribute("role", "img");
      svg.setAttribute("aria-label", `${key.count} ${key.type === "natural" ? "natural" : key.type + "s"} in the key signature`);

      // Staff lines
      const top = 60;
      const lineGap = 22;
      for (let i = 0; i < 5; i++) {
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", 30);
        line.setAttribute("y1", top + i * lineGap);
        line.setAttribute("x2", 380);
        line.setAttribute("y2", top + i * lineGap);
        line.setAttribute("stroke", "#153a5a");
        line.setAttribute("stroke-width", "2");
        svg.appendChild(line);
      }

      // Treble clef
      const clef = document.createElementNS(svgNS, "text");
      clef.textContent = "\uD834\uDD1E"; // Musical symbol G clef
      clef.setAttribute("x", 65);
      clef.setAttribute("y", top + lineGap * 4.3);
      clef.setAttribute("font-size", "130");
      clef.setAttribute("fill", "#153a5a");
      clef.setAttribute("font-family", "'Noto Music', 'Bravura', 'Maestro', 'Arial Unicode MS', serif");
      svg.appendChild(clef);

      if (key.type === "sharp" || key.type === "flat") {
        const steps = key.type === "sharp" ? sharpSteps : flatSteps;
        const accidentalChar = key.type === "sharp" ? "\u266F" : "\u266D";
        const startX = 130;
        const spacing = 34;
        const bottomStepY = top + lineGap * 4; // bottom line
        const stepSize = lineGap / 2; // distance between staff steps

        for (let i = 0; i < key.count; i++) {
          const text = document.createElementNS(svgNS, "text");
          text.textContent = accidentalChar;
          text.setAttribute("x", startX + i * spacing);
          const step = steps[i];
          const y = bottomStepY - step * stepSize + (key.type === "flat" ? 2 : 0);
          text.setAttribute("y", y);
          text.setAttribute("font-size", "64");
          text.setAttribute("fill", "#153a5a");
          text.setAttribute("font-family", "'Noto Music', 'Bravura', 'Maestro', 'Arial Unicode MS', serif");
          svg.appendChild(text);
        }
      }

      staffContainer.appendChild(svg);
    }

    function formatAccidentalText(key) {
      if (key.type === "natural" || key.count === 0) {
        return "No sharps or flats";
      }
      const symbol = key.type === "sharp" ? "\u266F" : "\u266D";
      const plural = key.count === 1 ? "" : "s";
      return `${key.count} ${symbol}${plural} in the signature`;
    }

    function selectKey() {
      if (usedIndices.length === keySignatures.length) {
        usedIndices = [];
      }

      let index;
      do {
        index = Math.floor(Math.random() * keySignatures.length);
      } while (usedIndices.includes(index) && usedIndices.length < keySignatures.length);

      usedIndices.push(index);
      return keySignatures[index];
    }

    function normalizeAnswer(text) {
      return text
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ")
        .replace(/sharp/g, "#")
        .replace(/flat/g, "b");
    }

    function expectedForms(name) {
      const canonical = name.toLowerCase();
      const alt = canonical
        .replace(/(\w)#/g, "$1 sharp")
        .replace(/(\w)b/g, "$1 flat");
      return new Set([canonical, alt]);
    }

    function isCorrect(answer, target) {
      const normalizedAnswer = normalizeAnswer(answer);
      const acceptable = expectedForms(target);
      return acceptable.has(normalizedAnswer);
    }

    function resetForms() {
      majorInput.value = "";
      minorInput.value = "";
      majorInput.disabled = false;
      minorInput.disabled = false;
      majorFeedback.classList.add("hidden");
      minorFeedback.classList.add("hidden");
      majorFeedback.textContent = "";
      minorFeedback.textContent = "";
      minorForm.classList.add("hidden");
      nextButton.classList.add("hidden");
    }

    function announceKey(key) {
      signatureMeta.textContent = formatAccidentalText(key);
    }

    function loadNextKey() {
      currentKey = selectKey();
      resetForms();
      createStaff(currentKey);
      announceKey(currentKey);
      majorInput.focus();
    }

    majorForm.addEventListener("submit", (event) => {
      event.preventDefault();
      if (!currentKey) return;

      const userAnswer = majorInput.value;
      const correct = isCorrect(userAnswer, currentKey.major);
      majorFeedback.textContent = correct
        ? `Correct! This key signature belongs to ${currentKey.major}.`
        : `Almost! The major key is ${currentKey.major}.`;
      majorFeedback.classList.remove("hidden");
      majorInput.disabled = true;
      majorForm.querySelector("button").disabled = true;
      minorForm.classList.remove("hidden");
      minorInput.focus();
    });

    minorForm.addEventListener("submit", (event) => {
      event.preventDefault();
      if (!currentKey) return;

      const userAnswer = minorInput.value;
      const correct = isCorrect(userAnswer, currentKey.minor);
      minorFeedback.textContent = correct
        ? `Correct! The relative minor is ${currentKey.minor}.`
        : `Good try! The relative minor is ${currentKey.minor}.`;
      minorFeedback.classList.remove("hidden");
      minorInput.disabled = true;
      minorForm.querySelector("button").disabled = true;
      nextButton.classList.remove("hidden");
      nextButton.focus();
    });

    nextButton.addEventListener("click", () => {
      majorForm.querySelector("button").disabled = false;
      minorForm.querySelector("button").disabled = false;
      loadNextKey();
    });

    loadNextKey();
  </script>
</body>
</html>
